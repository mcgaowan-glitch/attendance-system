<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簽到系統</title>
    <style>
        :root {
            --red-bg: #fff5f5; --red-border: #feb2b2; --red-text: #c53030;
            --green-bg: #f0fff4; --green-border: #9ae6b4; --green-text: #276749;
            --primary: #4299e1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f7fafc; }
        h2 { text-align: center; color: #2d3748; }

        .input-group { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; gap: 10px; margin-bottom: 25px; 
        }
        select, input { flex: 1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        button { 
            padding: 12px 24px; background: var(--primary); color: white; border: none; 
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }

        .stats-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 25px; 
        }
        .class-box { 
            padding: 15px 5px; text-align: center; border-radius: 10px; border: 2px solid; 
            transition: transform 0.2s; 
        }
        .class-box.not-arrived { background: var(--red-bg); border-color: var(--red-border); color: var(--red-text); }
        .class-box.has-arrived { background: var(--green-bg); border-color: var(--green-border); color: var(--green-text); }
        .class-name { font-size: 12px; margin-bottom: 4px; opacity: 0.8; }
        .class-count { font-size: 22px; font-weight: 800; }

        .list-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .list-header { font-weight: bold; padding: 10px; border-bottom: 2px solid #edf2f7; display: flex; justify-content: space-between; }
        ul { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        li { 
            padding: 12px; border-bottom: 1px solid #edf2f7; display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .tag { 
            background: #ebf8ff; color: #3182ce; padding: 2px 8px; 
            border-radius: 6px; font-size: 12px; margin-right: 8px; font-weight: bold;
        }
        .time { color: #a0aec0; font-size: 12px; }

        @media (max-width: 500px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .input-group { flex-direction: column; } }
    </style>
</head>
<body>

<h2>簽到系統</h2>

<div class="input-group">
    <select id="classSelect">
        <option value="">選擇班級...</option>
    </select>
    <input id="nameInput" placeholder="請輸入姓名" autocomplete="off">
    <button onclick="signin()" id="submitBtn">簽到</button>
</div>

<div class="list-header" style="border:none;">各班到齊概況 (紅色=缺席 / 綠色=人數)</div>
<div id="statsGrid" class="stats-grid"></div>

<div class="list-container">
    <div class="list-header">
        <span>最近簽到紀錄</span>
        <span id="totalCount" style="color: #718096; font-size: 14px;">總計：0 人</span>
    </div>
    <ul id="historyList"></ul>
</div>

<!-- 改用一般JS，不會被瀏覽器擋 -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
// 初始化 Firebase
const firebaseConfig = {
  apiKey: "AIzaSyACpUi6HAfPZueC-NHNbno-14ZepQ33U50",
  authDomain: "attendance-f20a7.firebaseapp.com",
  databaseURL: "https://attendance-f20a7-default-rtdb.firebaseio.com",
  projectId: "attendance-f20a7",
  storageBucket: "attendance-f20a7.firebasestorage.app",
  messagingSenderId: "1066917565778",
  appId: "1:1066917565778:web:6dacfdf248f85bb290168b",
  measurementId: "G-LGNCFVBR0G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dbRef = db.ref("attendance");

// 建立 1~15班
const classSelect = document.getElementById("classSelect");
for (let i = 1; i <= 15; i++) {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = i + " 班";
  classSelect.appendChild(opt);
}

// 簽到
function signin() {
  const className = classSelect.value;
  const name = document.getElementById("nameInput").value.trim();
  const btn = document.getElementById("submitBtn");

  if (!className || !name) {
    alert("班級跟姓名都要填寫喔！");
    return;
  }

  btn.disabled = true;

  dbRef.push({
    className: className,
    name: name,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  }).then(() => {
    document.getElementById("nameInput").value = "";
    document.getElementById("nameInput").focus();
  }).catch((err) => {
    alert("簽到失敗：" + err.message);
  }).finally(() => {
    btn.disabled = false;
  });
}

// 即時更新畫面
dbRef.on("value", (snapshot) => {
  const data = [];
  const counts = {};
  for (let i = 1; i <= 15; i++) counts[i] = 0;

  snapshot.forEach((child) => {
    const item = child.val();
    data.push(item);
    if (counts[item.className] !== undefined) {
      counts[item.className]++;
    }
  });

  updateStats(counts);
  updateList(data);
  document.getElementById("totalCount").textContent = "總計：" + data.length + " 人";
});

// 更新各班人數面板
function updateStats(counts) {
  const grid = document.getElementById("statsGrid");
  grid.innerHTML = "";
  for (let i = 1; i <= 15; i++) {
    const num = counts[i];
    const box = document.createElement("div");
    box.className = "class-box " + (num > 0 ? "has-arrived" : "not-arrived");
    box.innerHTML = `
      <div class="class-name">${i} 班</div>
      <div class="class-count">${num}</div>
    `;
    grid.appendChild(box);
  }
}

// 更新簽到記錄
function updateList(data) {
  const list = document.getElementById("historyList");
  let html = "";

  data.reverse().slice(0, 50).forEach(item => {
    let timeStr = "";
    if (item.timestamp) {
      const d = new Date(item.timestamp);
      timeStr = d.toLocaleTimeString('zh-TW', { hour12: false });
    }

    html += `
    <li>
      <div>
        <span class="tag">${item.className} 班</span>
        <strong>${item.name}</strong>
      </div>
      <span class="time">${timeStr}</span>
    </li>
    `;
  });

  list.innerHTML = html;
}

// Enter 鍵簽到
document.getElementById("nameInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") signin();
});
</script>
</body>
</html>

